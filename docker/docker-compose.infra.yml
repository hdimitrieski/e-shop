version: '3.9'

services:
  eshop-base:
    image: eshop-base:latest
    build:
      context: ./base
      dockerfile: Dockerfile
    restart: "no"

  config:
    build: ../infrastructure/config
    networks:
      - eshopnet
    ports:
      - 8888:8888
    restart: on-failure
    environment:
      SPRING_PROFILES_ACTIVE: docker,native
      CONFIG_SERVICE_USER: ${CONFIG_SERVICE_USER}
      CONFIG_SERVICE_PASSWORD: ${CONFIG_SERVICE_PASSWORD}
      CONFIG_KEYSTORE_PASSWORD: ${CONFIG_KEYSTORE_PASSWORD}
      CONFIG_KEY_PASSWORD: ${CONFIG_KEY_PASSWORD}
      EUREKA_USER: ${EUREKA_USER}
      POSTGRES_USER: ${POSTGRES_USER}

  discovery:
    build: ../infrastructure/discovery
    networks:
      - eshopnet
    ports:
      - 8761:8761
    restart: on-failure
    environment:
      SPRING_PROFILES_ACTIVE: docker
      CONFIG_SERVICE_USER: ${CONFIG_SERVICE_USER}
      CONFIG_SERVICE_PASSWORD: ${CONFIG_SERVICE_PASSWORD}
      EUREKA_USER: ${EUREKA_USER}
    depends_on:
      - config

  gateway:
    build: ../infrastructure/gateway
    networks:
      - eshopnet
    ports:
      - 3000:8080
    restart: on-failure
    environment:
      SPRING_PROFILES_ACTIVE: docker
      CONFIG_SERVICE_USER: ${CONFIG_SERVICE_USER}
      CONFIG_SERVICE_PASSWORD: ${CONFIG_SERVICE_PASSWORD}
      EUREKA_USER: ${EUREKA_USER}
    depends_on:
      - config
      - discovery
      - eshop-base

networks:
  eshopnet:
    driver: bridge
